<!DOCTYPE html>
<html>

<head>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="/css/main.css">
    <title>Cancel Ben Tsardoulias</title>
    <style>
        /* Add CSS to center the content on the page */
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
        }

        .container,
        .day-counter {
            width: 90%;
            /* Or any other width */
            margin: auto;
            text-align: center;
            /* Centers text within the containers */
        }
    </style>
</head>

<body onload="fetchCurrentCount(); updateProgressBar({value: 0})">
    <div class="container">
        <div class="title">
            <h1>CANCEL BEN TSARDOULIAS</h1>
        </div>
        <div class="counter">I have been canceled <span id="counter">0</span> times</div>
        <div class="progress-container">
            <progress id="progress-bar" value="0" max="1000000"></progress>
            <span id="progress-percentage" class="progress-percentage"></span>
        </div>
        <div class="buttons-container">
            <button onclick="incrementCounter(1)">Cancel me</button>
            <button onclick="incrementCounter(5)">Cancel me x5</button>
            <button onclick="incrementCounter(10)">Cancel me x10</button>
            <button onclick="incrementCounter(25)">Cancel me x25</button>
        </div>
    </div>

    <div class="day-counter">
        It has been <span id="days-since"></span> since this started
    </div>

    <script>

        function numberWithCommas(x) {
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        // JavaScript code
        function getTimeSince() {
            const startDate = new Date("October 30, 2023 00:50:00");
            const currentDate = new Date();
            const timeDiff = Math.abs(currentDate.getTime() - startDate.getTime());
            const daysDiff = Math.floor(timeDiff / (1000 * 3600 * 24));
            const hoursDiff = Math.floor((timeDiff % (1000 * 3600 * 24)) / (1000 * 3600));
            const minutesDiff = Math.floor((timeDiff % (1000 * 3600)) / (1000 * 60));
            const secondsDiff = Math.floor((timeDiff % (1000 * 60)) / 1000);
            return {
                days: daysDiff,
                hours: hoursDiff,
                minutes: minutesDiff,
                seconds: secondsDiff
            };
        }

        function updateProgressBar(data) {
            const progressBar = document.getElementById('progress-bar');
            const percentageSpan = document.getElementById('progress-percentage');
            const startValue = progressBar.value;
            const endValue = data.value;
            const duration = 1000; // duration of the animation in milliseconds
            const startTime = performance.now();

            function animate(currentTime) {
                const elapsedTime = currentTime - startTime;
                const progress = Math.min(elapsedTime / duration, 1);
                const currentValue = startValue + (endValue - startValue) * progress;

                progressBar.value = currentValue;
                const percentage = Math.floor((currentValue / progressBar.max) * 100.00);
                percentageSpan.textContent = percentage + "%";

                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    // When animation is complete, format the final value with commas
                    document.getElementById('counter').textContent = numberWithCommas(endValue);
                }
            }

            requestAnimationFrame(animate);
        }

        async function fetchCurrentCount() {
            try {
                const response = await fetch('/current-count');
                const data = await response.json();
                updateProgressBar(data);


                let displayedCount = 0;
                const counterElem = document.getElementById('counter');

                function updateCounter() {
                    // Calculate the remaining difference
                    const difference = data.value - displayedCount;
                    // Adjust the speed based on the remaining difference. The larger the difference, the bigger the step.
                    const step = Math.max(1, Math.ceil(difference * 0.05)); // 5% of the remaining difference

                    if (displayedCount + step < data.value) {
                        displayedCount += step;
                        counterElem.textContent = numberWithCommas(displayedCount);
                        // Use setTimeout instead of setInterval for dynamic intervals
                        setTimeout(updateCounter, 2);
                    } else {
                        counterElem.textContent = data.value; // directly set the final value
                    }
                }

                updateCounter();
                counterElem.textContent = numberWithCommas(data.value);

            } catch (error) {
                console.error(error);
            }
        }

        async function incrementCounter(amount = 1) {
            const counterElem = document.getElementById('counter');
            const currentCount = parseInt(counterElem.textContent, 10);

            try {
                const response = await fetch('/increment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ amount: amount })
                });

                const data = await response.json();

                let displayedCount = currentCount;

                function updateCounter() {
                    // Same logic as above
                    const difference = data.value - displayedCount;
                    const step = Math.max(1, Math.ceil(difference * 0.05));

                    if (displayedCount + step < data.value) {
                        displayedCount += step;
                        counterElem.textContent = numberWithCommas(displayedCount); // Format the number with commas
                        setTimeout(updateCounter, 2);
                    } else {
                        // When the final value is reached, ensure it's formatted with commas
                        counterElem.textContent = numberWithCommas(data.value); // Format the final number with commas
                    }
                }

                updateCounter();

            } catch (error) {
                console.error('Failed to update count:', error);
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            // Only DOMContentLoaded-specific code here
            setInterval(function () {
                const timeSince = getTimeSince();
                const daysSince = `${timeSince.days} days, ${timeSince.hours} hours, ${timeSince.minutes} minutes, ${timeSince.seconds} seconds`;
                document.getElementById("counter").textContent = numberWithCommas(data.value);
                document.getElementById("days-since").textContent = daysSince;
            }, 1000);
        });
    </script>

</body>

</html>