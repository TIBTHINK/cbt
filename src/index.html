<!DOCTYPE html>
<html>

<head>
    <script src="/socket.io/socket.io.js"></script>
    
    <link rel="stylesheet" href="/css/main.css">

    <title>Cancel Ben Tsardoulias</title>
</head>
<!-- add css with the content being in the center of the page  -->
<style>
    
</style>

<body onload="fetchCurrentCount()">
    
    <div class="container">
        <div class="title">
            <h1>CANCEL BEN TSARDOULIAS</h1>
        </div>
        <div class="counter">I have been canceled <span id="counter">0</span> times</div>
        <div class="progress-container">
            <progress id="progress-bar" value="" max="1000000"></progress>
            <span id="progress-percentage" class="progress-percentage"></span>
        </div> 

        <div class="buttons-container">
            <button onclick="incrementCounter(1)">Cancel me</button>
            <button onclick="incrementCounter(5)">Cancel me 5 </button>
            <button onclick="incrementCounter(10)">Cancel me 10</button>
            <button onclick="incrementCounter(25)">Cancel me 25</button>
        </div>
    </div>



    <script>

        function getDaysSince() {
            const startDate = new Date("October 29, 2023");
            const currentDate = new Date();
            const timeDiff = Math.abs(currentDate.getTime() - startDate.getTime());
            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
            return daysDiff;
        }

        document.addEventListener("DOMContentLoaded", function () {
            const daysSince = getDaysSince();
            document.getElementById("days-since").textContent = daysSince;
        });
    </script>

    <body>
        <div class="day-counter">
            It has been <span id="days-since"></span> days since this started
        </div>
    </body>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        
            const socket = io();
            const progressBar = document.getElementById('progress-bar');
            const percentageSpan = document.getElementById('progress-percentage'); // Define it here


            // Listen for counterUpdated event from the server
            socket.on('counterUpdated', (data) => {
            document.getElementById('counter').textContent = data.value;
            progressBar.value = data.value;

            const percentage = Math.floor((data.value / progressBar.max) * 100.00);
            percentageSpan.textContent = percentage + "%"; // Use the variable here
        });

        async function fetchCurrentCount() {
    try {
        const response = await fetch('/current-count');
        const data = await response.json();

        let displayedCount = 0;
        const counterElem = document.getElementById('counter');

        function updateCounter() {
            // Calculate the remaining difference
            const difference = data.value - displayedCount;
            // Adjust the speed based on the remaining difference. The larger the difference, the bigger the step.
            const step = Math.max(1, Math.ceil(difference * 0.05)); // 5% of the remaining difference

            if (displayedCount + step < data.value) {
                displayedCount += step;
                counterElem.textContent = displayedCount;
                // Use setTimeout instead of setInterval for dynamic intervals
                setTimeout(updateCounter, 2);
            } else {
                counterElem.textContent = data.value; // directly set the final value
            }
        }

        updateCounter();

    } catch (error) {
        console.error(error);
    }
}

async function incrementCounter(amount = 1) {  
    const counterElem = document.getElementById('counter');
    const currentCount = parseInt(counterElem.textContent, 10);

    try {
        const response = await fetch('/increment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ amount: amount })  
        });
        
        const data = await response.json();
        
        let displayedCount = currentCount;

        function updateCounter() {
            // Same logic as above
            const difference = data.value - displayedCount;
            const step = Math.max(1, Math.ceil(difference * 0.05)); 

            if (displayedCount + step < data.value) {
                displayedCount += step;
                counterElem.textContent = displayedCount;
                setTimeout(updateCounter, 2);
            } else {
                counterElem.textContent = data.value;
            }
        }

        updateCounter();

    } catch (error) {
        console.error('Failed to update count:', error);
    }
}
    </script>
</body>

</html>